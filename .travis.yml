language: node_js

sudo: required

node_js:
  - "10.14.0"

cache:
  directories:
    - node_modules

env:
  global:
    - CXX=g++-4.8
    - GH_REPO_DEMO="https://$GH_TOKEN@github.com/smartpublish/SMART-Publish-Research-demo.git"

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - build-essential
      - g++-4.8

jobs:
  include:
    - stage: test
      name: "Smart contracts"
      before_install:
      - cd dapp
      install:
      - npm i --silent --no-optional -g truffle ganache-cli
      - npm i
      script:
      - ganache-cli -l 8000000 > /dev/null 2>&1 &
      - sleep 5;
      - truffle test;

    - stage: deploy demo
      name: "Deploy demo on Ropsten"
      provider: script
      install:
      - npm i --silent --no-optional -g truffle @angular/cli
      - npm i --prefix dapp/
      - npm i --prefix webapp/
      script:
      - cd dapp/ || exit;
      - truffle migrate --network ropsten;
      - truffle exec seed.js;
      - cd ../webapp/ || exit;
      - npm run ng-high-memory -- build --prod --base-href /SMART-Publish-Research-demo/ --deploy-url /SMART-Publish-Research-demo/ --source-map=false;
      - npx angular-cli-ghpages --dir=dist/webapp --repo="$GH_REPO_DEMO" --name="$GH_USER" --email="$GH_EMAIL" --branch=master;
      on:
        branch: dev
